<!doctype html>
<!-- this is a template for the web server -->
<html>

<head>
    <title>Cluster status</title>
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css"
        integrity="sha384-oAOxQR6DkCoMliIh8yFnu25d7Eq/PHS21PClpwjOTeU2jRSq11vu66rf90/cZr47" crossorigin="anonymous">
    <link rel="icon" type="image/png" href="cf_icon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        h1 {
            color: #E00A13;
        }

        .miniheading h2 {
            color: #E00A13;
        }

        .statusheading {
            color: black;
            background-color: #FFFF00;
            font-size: smaller;
            padding: 0.5em;
        }

        .statusheading-error {
            color: white;
            background-color: #E00A13;
        }

        .statusheading-ok {
            color: white;
            background-color: #00AA00;
        }

        .l-box {
            padding: 1em;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

</head>

<body>

    <div class="pure-g">
        <div class="pure-u-1-2">
            <div class="l-box">
                <img src="clusterfunk_logo.png" />
            </div>
        </div>
        <div class="pure-u-1-2">
            <div class="l-box">
                <h1>Node <span id="node-id"></span></h1>
            </div>
        </div>
        <div class="pure-u-1-1 statusheading" id="status">
            disconnected
        </div>
        <div class="pure-u-1-3 miniheading">
            <div class="l-box">
                <h2>State</h2>
                <div>State: <span id="node-state"></span></div>
                <div>Role: <span id="node-role"></span></div>

            </div>
        </div>
        <div class="pure-u-1-3 miniheading">
            <div class="l-box">
                <h2>Members</h2>
                <table class="pure-table" id="members">
                    <thead>
                        <tr>
                            <th>Role</th>
                            <th>ID</th>
                            <th>Status page</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>diverse</td>
                            <td>dr</td>
                            <td>who</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="pure-u-1-3 miniheading">
            <div class="l-box">
                <h2>Shards</h2>
                <table class="pure-table" id="shards">
                    <thead>
                        <tr>
                            <th>
                                Node ID
                            </th>
                            <th>
                                Number of shards
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>(no members)</td>
                            <td>-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
<script lang="javascript">

    $(document).ready(function (e) {
        // Connect to the web socket
        var url = new URL('/statusws', window.location.href);
        url.protocol = url.protocol.replace('http', 'ws');
        var ws = new WebSocket(url.href);
        console.debug('Opening websocket ', url)
        ws.onmessage = function (ev) {
            var msg = JSON.parse(ev.data);
            switch (msg.type) {

                case "info":
                    // info on local node. Sent right after connect.
                    $('#node-id').text(msg.nodeId);
                    $('#node-state').text(msg.state);
                    $('#node-role').text(msg.role);
                    break;

                case "status":
                    // Status has changed. Sent continuously and after connect.
                    $('#node-state').text(msg.state);
                    $('#node-role').text(msg.role);
                    break;

                case "members":
                    // member list is updated. Sent after connect + cluster events.
                    var memberList = $('#members').find('tbody');
                    memberList.empty();
                    for (var i = 0; i < msg.members.length; i++) {
                        var elem = $('<tr>')
                            .append($('<td>')
                                .text(msg.members[i].id));
                        if (msg.members[i].id == msg.leaderId) {
                            elem.append($('<td>').text("Leader"));
                        } else {
                            elem.append($('<td>').text("Follower"))
                        }
                        var link
                        elem.append($('<td>')
                            .append($('<a>')
                                .attr('href', 'http://' + msg.members[i].http + '/')
                                .text(msg.members[i].http)))
                        memberList.append(elem);
                    }
                    break;

                case "shards":
                    var shardList = $('#shards').find('tbody');
                    shardList.empty();
                    console.log(msg);
                    for (var node in msg.shards) {
                        shardList.append($('<tr>')
                            .append('<td>' + node + '</td><td>' + msg.shards[node] + '</td>'));
                    }
                    // shard list is updated. Sent after connect + cluster events.
                    break;
                default:
                    console.log('Unknown message', msg);
            }
        };
        ws.onerror = function (s, ev) {
            $('#status').removeClass('statusheading-ok');
            $('#status').removeClass('statusheading-error');
            $('#status').addClass('statusheading-error');
            $('#status').text('error');

        };
        ws.onopen = function (s, ev) {
            $('#status').removeClass('statusheading-ok');
            $('#status').removeClass('statusheading-error');
            $('#status').addClass('statusheading-ok');
            $('#status').text('connected');
        };

        ws.onclose = function (s, ev) {
            $('#status').removeClass('statusheading-ok');
            $('#status').removeClass('statusheading-error');
            $('#status').text('closed');
        };
    });
</script>

</html>