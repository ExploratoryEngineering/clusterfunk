<!doctype html>
<!-- this is a template for the web server -->
<html>

<head>
    <title>Cluster status</title>
    <link rel="icon" type="image/png" href="cf_icon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
</head>

<body>
    <div id="demoApp">
        <img src="clusterfunk_logo.png" />
        <h1>Node {{ nodeId }}: {{ state }} {{ role }} </h1>
        <h2>Cluster members</h2>
        <table border="1">
            <thead>
                <tr>
                    <th>&nbsp;</th>
                    <th>Node ID</th>
                    <th>Shards</th>
                    <th>Status page</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="member in members">
                    <td :bgcolor="toColor(member.nodeId)">&nbsp;&nbsp;</td>
                    <td>{{ member.nodeId }} </td>
                    <td> {{ member.shards }}</td>
                    <td><a :href="member.httpEndpoint">{{ member.httpEndpoint }}</a></td>
                </tr>
            </tbody>
        </table>
    </div>

    <script src="demo.js"></script>

    <!--        <table>
            <thead>
                <tr>
                    <th>&nbsp;</th>
                    <th>Role</th>
                    <th>ID</th>
                    <th>Status page</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>diverse</td>
                    <td>dr</td>
                    <td>who</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="state-box"><span id="node-state"></span></div>
    <h2>Members</h2>

    <h2>Shards</h2>
    <table id="shards">
        <thead>
            <tr>
                <th>Node ID</th>
                <th>Number of shards</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>(no members)</td>
                <td>-</td>
            </tr>
        </tbody>
    </table>

    <div id="status">
        disconnected
    </div>
</body>

<script lang="javascript">
    var currentNodeId = '';
    var currentMemberCount = 0;

    // Disable the display when there's an error with the websocket.
    function disableDisplay(message) {
        $('#status').removeClass('statusheading-ok');
        $('#status').removeClass('statusheading-error');
        $('#status').text(message);
        currentNodeId = '';
        $('#state-content').hide();
        $('#member-content').hide();
        $('#shard-content').hide();
    }

    // Enable the display when the websocket is connected
    function enableDisplay() {
        $('#status').removeClass('statusheading-ok');
        $('#status').removeClass('statusheading-error');
        $('#status').addClass('statusheading-ok');
        $('#status').text('Connected to websocket, receiving events');
        $('#state-content').show();
        $('#member-content').show();
        $('#shard-content').show();
        currentNodeId = '';
    }

    // Convert the node ID into a RGB hex colour.
    function idToColor(id) {
        return '#' + id.substring(0, 6);
    }

    function infoMessage(msg) {
        // info on local node. Sent right after connect.
        $('#node-id').text(msg.nodeId);
        $('#node-state').text(msg.state);
        $('#state-box').attr('class', msg.state.toLowerCase());
        currentNodeId = msg.nodeId;
    }

    function statusMessage(msg) {
        // Status has changed. Sent continuously and after connect.
        $('#node-state').text(msg.state);
        $('#state-box').attr('class', msg.state.toLowerCase());
    }


    function memberMessage(msg) {
        // member list is updated. Sent after connect + cluster events.
        var memberList = $('#members').find('tbody');
        memberList.empty();
        currentMemberCount = msg.members.length;
        for (var i = 0; i < currentMemberCount; i++) {

            var firstCol = $('<td>')
                .attr('style', 'background-color:' + idToColor(msg.members[i].id));

            if (msg.members[i].id == currentNodeId) {
                firstCol.append($('<img>').attr('src', 'cf_icon.png').attr('width', '24').text(' '));
            } else {
                firstCol.text(" ");
            }

            var secondCol = $('<td>')
                .text(msg.members[i].id);

            var thirdCol = $('<td>');
            if (msg.members[i].id == msg.leaderId) {
                thirdCol.text("Leader");
            } else {
                thirdCol.text("Follower");
            }

            var fourthCol = $('<td>')
                .append($('<a>')
                    .attr('href', 'http://' + msg.members[i].http + '/')
                    .text(msg.members[i].http));

            memberList.append($('<tr>')
                .append(firstCol)
                .append(secondCol)
                .append(thirdCol)
                .append(fourthCol));
        }
    }

    function shardMessage(msg) {
        var shardList = $('#shards').find('tbody');
        shardList.empty();
        for (var node in msg.shards) {
            shardList.append($('<tr>')
                .append('<td>' + node + '</td><td>' + msg.shards[node] + '</td>'));
        }
        // shard list is updated. Sent after connect + cluster events.
    }


    $(document).ready(function (e) {
        // Set up websocket
        var url = new URL('/statusws', window.location.href);
        url.protocol = url.protocol.replace('http', 'ws');
        var ws = new WebSocket(url.href);
        console.debug('Opening websocket ', url)

        ws.onmessage = function (ev) {
            if (ev.data == null) {
                return;
            }
            var msg = JSON.parse(ev.data);
            if (!msg) {
                return;
            }
            switch (msg.type) {

                case "info":
                    infoMessage(msg);
                    break;

                case "status":
                    statusMessage(msg);
                    break;

                case "members":
                    memberMessage(msg);

                    break;

                case "shards":
                    shardMessage(msg);
                    break;
                default:
                    console.log('Unknown message', msg);
            }
        };
        ws.onerror = function (s, ev) {
            disableDisplay('Error reading from websocket');
        };
        ws.onopen = function (s, ev) {
            enableDisplay();
        };
        ws.onclose = function (s, ev) {
            disableDisplay('Websocket closed');
        };
    });


</script>
-->

</html>